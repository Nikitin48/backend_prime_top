# backend_prime_top

## API Overview

Все эндпоинты доступны по префиксу `/api/` и возвращают ответы в формате JSON. Для защищённых маршрутов используйте заголовок `Authorization: Token <токен>`, полученный через эндпоинт логина.

См. раздел «Аутентификация и регистрация» в файле `AUTH_API.md`.

### `GET /api/me/orders/current/` _(требуется токен)_
- **Назначение**: активные заказы клиента (без доставленных и отменённых).
- **Фильтры**:
  - `status` — список статусов (несколько значений или через запятую);
  - `limit` — ограничение количества записей;
  - `include_items` — `true|false`, добавлять ли позиции заказа (по умолчанию `false`).
- **Ответ**:
  - `summary` — агрегат по статусам;
  - `orders` — список заказов (минимальный набор полей, если `include_items=false`).

### `GET /api/me/orders/history/` _(требуется токен)_
- **Назначение**: полная история заказов клиента.
- **Фильтры**:
  - `status` — список статусов;
  - `created_from` / `created_to` — диапазон дат (`YYYY-MM-DD`);
  - `limit` — ограничение количества записей;
  - `include_items` — `true|false` (по умолчанию `true`).
- **Ответ**: аналогично текущим заказам, но со всеми позициями и статусной историей.

### `GET /api/me/stocks/` _(требуется токен)_
- **Назначение**: остатки, доступные клиенту (собственные и свободные).
- **Фильтры**:
  - `include_public` — `true|false`, добавлять общий склад (по умолчанию `true`);
  - `personal_only` — `true|false`, только персональные резервы (по умолчанию `false`);
  - `series`, `color`, `coating_type`;
  - `min_<поле>` / `max_<поле>` — фильтр по лабораторным показателям (`analyses_*`).
- **Ответ**:
  - `personal` / `public` — массивы записей с сериями, анализами и суммарными количествами;
  - `summary_by_nomenclature` — агрегаты по номенклатурам.

### `GET /api/clients/<client_id>/orders/summary/`
- **Назначение**: агрегированная статистика заказов клиента.
- **Фильтры**: отсутствуют.
- **Ответ**:
  - `client`: данные клиента.
  - `summary`: список статусов с количеством заказов, серий и суммарным объемом.
  - `cancel_details`: причины отмены с количеством.
  - `period`: даты первого и последнего заказа.

### `GET /api/clients/<client_id>/orders/`
- **Назначение**: детализированные позиции заказов клиента.
- **Фильтры (query params)**:
  - `status` — фильтр по статусу заказа (строка).
  - `series` — поиск по части идентификатора серии.
  - `color` — поиск по цвету/номенклатуре/RAL (определяется автоматически).
- **Ответ**:
  - `client`: данные клиента.
  - `count`: количество записей.
  - `orders`: массив позиций с информацией о заказе, серии, изделии и покрытии.

### `GET /api/stocks/`
- **Назначение**: остатки на складе.
- **Фильтры (query params)**:
  - `client_id` — идентификатор клиента;
  - `include_public` — `true|false`, добавлять ли общие остатки при указании клиента (по умолчанию `false`);
  - `personal_only` — `true|false`, только персональные остатки клиента (по умолчанию `true`);
  - `series` — поиск по части серии (ID или название);
  - `series_id` — точное совпадение по ID серии (целое число);
  - `color` — поиск по цвету/номенклатуре/RAL;
  - `coating_type` — фильтр по названию/номенклатуре покрытия;
  - `min_<поле>` / `max_<поле>` — числовые фильтры по лабораторным характеристикам (`analyses_*`) для диапазонов;
  - `analyses_blesk_pri_60_grad` — точное значение блеска при 60 градусах (число);
  - `analyses_uslovnaya_vyazkost` — точное значение условной вязкости (число);
  - `analyses_delta_e` — точное значение Delta E (число);
  - `analyses_delta_l` — точное значение Delta L (число);
  - `analyses_delta_a` — точное значение Delta A (число);
  - `analyses_delta_b` — точное значение Delta B (число);
  - `offset` — смещение для пагинации (неотрицательное число);
  - `limit` — ограничение количества результатов (положительное число).
- **Ответ**:
  - `client`: данные клиента (если указан).
  - `summary_by_nomenclature`: агрегированная статистика по номенклатурам (рассчитывается на всех данных).
  - `count`: количество записей в текущем ответе (с учетом пагинации).
  - `total_count`: общее количество записей (без учета пагинации).
  - `series`: список серий с остатками и дополнительной информацией (с учетом пагинации).
- **Примеры запросов**:
  - `GET /api/stocks/?series_id=207` — остатки для серии с ID 207
  - `GET /api/stocks/?analyses_blesk_pri_60_grad=85.5` — остатки с блеском 85.5
  - `GET /api/stocks/?analyses_delta_e=2.3&analyses_delta_l=1.5` — комбинация фильтров по анализам
  - `GET /api/stocks/?series_id=207&analyses_blesk_pri_60_grad=85.5&min_analyses_delta_e=1.0&max_analyses_delta_e=3.0` — комбинация точных и диапазонных фильтров

### `GET /api/clients/`
- **Назначение**: список клиентов.
- **Фильтры**:
  - `search` — поиск по имени или e-mail.
- **Ответ**: `count` и `results` с массивом клиентов.

### `POST /api/clients/`
- **Назначение**: создание клиента.
- **Тело запроса**:
  ```json
  {
    "name": "ООО \"ЛКМ\"",
    "email": "info@example.com"
  }
  ```
- **Ответ**: созданный клиент.

### `GET /api/clients/<client_id>/`
- **Назначение**: детальная информация о клиенте.
- **Ответ**: клиент.

### `PATCH /api/clients/<client_id>/`
- **Назначение**: обновление имени/e-mail клиента.
- **Тело запроса**: частичный JSON с полями `name` и/или `email`.
- **Ответ**: обновлённый клиент.

### `GET /api/products/`
- **Назначение**: список продуктов с типами покрытий.
- **Фильтры**:
  - `coating_type_id` — фильтрация по ID типа покрытия (целое число). Если не указан, возвращаются все продукты;
  - `name` — поиск по названию;
  - `nomenclature` — поиск по номенклатуре покрытия;
  - `color` — поиск по цвету, номенклатуре или RAL;
  - `min_price` / `max_price` — диапазон цены (целые числа);
  - `limit` — количество записей на странице (целое положительное число);
  - `offset` — смещение для пагинации (целое неотрицательное число).
- **Ответ**: `count` (общее количество записей) и `results` (список продуктов на текущей странице).
- **Примеры**:
  - `GET /api/products/` — все продукты
  - `GET /api/products/?coating_type_id=1` — продукты с типом покрытия ID=1
  - `GET /api/products/?coating_type_id=2&min_price=100` — продукты с типом покрытия ID=2 и ценой от 100
  - `GET /api/products/?limit=10&offset=0` — первые 10 продуктов
  - `GET /api/products/?limit=20&offset=20` — продукты с 21 по 40

### `GET /api/coating-types/`
- **Назначение**: получить список всех категорий типов покрытий (coating types).
- **Описание**: Возвращает все доступные категории типов покрытий. В настоящее время в системе 9 категорий, но в будущем их количество может увеличиваться.
- **Фильтры (query params)**:
  - `sort` — порядок сортировки (по умолчанию: `nomenclature`).
    Возможные значения:
    - `id` / `-id` — сортировка по идентификатору (по возрастанию / убыванию)
    - `name` / `-name` — сортировка по названию (по возрастанию / убыванию)
    - `nomenclature` / `-nomenclature` — сортировка по номенклатуре (по возрастанию / убыванию, по умолчанию)
- **Ответ**:
  ```json
  {
    "count": 9,
    "results": [
      {
        "id": 1,
        "name": "Название типа покрытия",
        "nomenclature": "НОМ-001"
      },
      ...
    ]
  }
  ```
- **Пример запроса**:
  ```
  GET /api/coating-types/
  GET /api/coating-types/?sort=name
  GET /api/coating-types/?sort=-id
  ```
- **Примечания**:
  - Endpoint не требует аутентификации (публичный доступ)
  - Все категории возвращаются в одном запросе (пагинация не предусмотрена, так как количество категорий ограничено)
  - Сортировка по умолчанию: по номенклатуре в алфавитном порядке

### `GET /api/series/`
- **Назначение**: список серий с расчетом остатка.
- **Фильтры**:
  - `product_id` — идентификатор продукта;
  - `series` — поиск по номеру серии;
  - `color` — поиск по цвету/номенклатуре/RAL;
  - `in_stock` — `true|false`, возвращать только доступные остатки.
- **Ответ**: `count` и `results`, где каждая серия дополнена продуктом и `available_quantity`.

### `GET /api/orders/`
- **Назначение**: список заказов с агрегированными показателями.
- **Фильтры**:
  - `client_id` — фильтр по клиенту;
  - `status` — фильтр по статусу;
  - `created_from` / `created_to` — диапазон дат (ISO, `YYYY-MM-DD`).
- **Ответ**: `count` и массив заказов с суммарным количеством, сериями и позиций.

### `POST /api/orders/`
- **Назначение**: создание заказа с позициями.
- **Тело запроса (пример)**:
  ```json
  {
    "client_id": 1,
    "status": "В ожидании",
    "items": [
      {"product_id": 5, "series_id": "SR-001", "quantity": 3}
    ],
    "status_note": "Создан через API"
  }
  ```
- **Ответ**: созданный заказ с позициями и историей статусов.

### `GET /api/orders/<order_id>/`
- **Назначение**: детальная информация о заказе.
- **Ответ**: заказ, позиции, история статусов.

### `PATCH /api/orders/<order_id>/`
- **Назначение**: обновление статуса, дат отгрузки/доставки и причины отмены.
- **Тело запроса**: частичный JSON с полями `status`, `shipped_at`, `delivered_at`, `cancel_reason`, `status_note`.
- **Ответ**: обновлённый заказ с позициями и историей.

### `GET /api/analyses/`
- **Назначение**: подбор серий по результатам лабораторных анализов.
- **Фильтры (query params)**:
  - `client_id` — идентификатор клиента;
  - `accessible_only` — `true|false`, включать ли только доступные клиенту серии (по умолчанию `true`);
  - `limit` — ограничение количества записей (целое число);
  - `sort` — поле сортировки (`available_quantity` или любое измерение; префикс `-` для убывания);
  - `min_<поле>` / `max_<поле>` — числовые диапазоны для любого из полей измерений.  
    Пример: `min_analyses_uslovnaya_vyazkost=80&max_analyses_uslovnaya_vyazkost=95`.
- **Ответ**:
  - `client`: данные клиента (если указан).
  - `count`: количество найденных серий.
  - `results`: список серий с доступным объемом, признаком резервирования и метриками.
